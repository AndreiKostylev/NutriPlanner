<UserControl x:Class="NutriPlanner.Views.AdminPanelView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             Background="White">

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Заголовок -->
        <Border Grid.Row="0" Background="#1976D2" CornerRadius="5" Padding="15" Margin="0,0,0,10">
            <StackPanel>
                <TextBlock Text="⚙️ Панель администратора" 
                           Foreground="White" 
                           FontSize="18" 
                           FontWeight="Bold"/>
                <WrapPanel Margin="0,10,0,0">
                    <Button Content="🔄 Обновить" 
                            Command="{Binding RefreshCommand}"
                            Padding="10,5"
                            Background="White"
                            Foreground="#1976D2"
                            Margin="0,0,10,0"/>

                    <TextBlock Text="{Binding AllUsers.Count, StringFormat={}Пользователей: {0}}"
                               VerticalAlignment="Center"
                               Foreground="White"
                               FontWeight="Bold"/>
                </WrapPanel>
            </StackPanel>
        </Border>

        <!-- Статистика -->
        <GroupBox Grid.Row="1" Header="📊 Статистика системы" Margin="0,0,0,10" Padding="10">
            <WrapPanel>
                <Border BorderBrush="#1976D2" BorderThickness="1" CornerRadius="5" Padding="10" Margin="5">
                    <StackPanel>
                        <TextBlock Text="Пользователи:" FontWeight="Bold"/>
                        <TextBlock Text="{Binding TotalUsers, StringFormat={}Всего: {0}}"/>
                        <TextBlock Text="{Binding TotalAdmins, StringFormat={}Админов: {0}}"/>
                        <TextBlock Text="{Binding TotalDietitians, StringFormat={}Диетологов: {0}}"/>
                        <TextBlock Text="{Binding TotalRegularUsers, StringFormat={}Обычных: {0}}"/>
                    </StackPanel>
                </Border>

                <Border BorderBrush="#4CAF50" BorderThickness="1" CornerRadius="5" Padding="10" Margin="5">
                    <StackPanel>
                        <TextBlock Text="Данные:" FontWeight="Bold"/>
                        <TextBlock Text="{Binding TotalProducts, StringFormat={}Продуктов: {0}}"/>
                        <TextBlock Text="{Binding TotalPlans, StringFormat={}Планов: {0}}"/>
                    </StackPanel>
                </Border>
            </WrapPanel>
        </GroupBox>

        <!-- Список пользователей -->
        <GroupBox Grid.Row="2" Header="👥 Управление пользователями" Padding="5">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Поиск -->
                <Border Grid.Row="0" Background="#FAFAFA" Padding="8" Margin="0,0,0,5">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="🔍 Поиск:" 
                                   VerticalAlignment="Center" 
                                   Margin="0,0,10,0"/>
                        <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                                 Width="250" 
                                 Padding="5"/>
                    </StackPanel>
                </Border>

                <!-- Таблица -->
                <DataGrid Grid.Row="1" 
                          ItemsSource="{Binding AllUsers}"
                          SelectedItem="{Binding SelectedUser}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          IsReadOnly="True"
                          SelectionMode="Single"
                          MinHeight="200">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Логин" 
                                            Binding="{Binding Username}" 
                                            Width="120"/>
                        <DataGridTextColumn Header="Email" 
                                            Binding="{Binding Email}" 
                                            Width="150"/>
                        <DataGridTextColumn Header="Роль" 
                                            Binding="{Binding RoleName}" 
                                            Width="100"/>

                        <!-- Статус - упрощенный вариант -->
                        <DataGridTemplateColumn Header="Статус" Width="80">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock>
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="{}{0}">
                                                <Binding Path="IsActive"/>
                                            </MultiBinding>
                                        </TextBlock.Text>
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="Неактивен"/>
                                                <Setter Property="Foreground" Value="Red"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsActive}" Value="True">
                                                        <Setter Property="Text" Value="Активен"/>
                                                        <Setter Property="Foreground" Value="Green"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn Header="Регистрация" 
                                            Binding="{Binding RegistrationDate, StringFormat={}{0:dd.MM.yy}}" 
                                            Width="90"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Панель управления -->
                <Border Grid.Row="2" Background="#F5F5F5" Padding="10" Margin="0,5,0,0">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="Выбран пользователь: " 
                                   VerticalAlignment="Center"
                                   Margin="0,0,5,0"/>
                        <TextBlock Text="{Binding SelectedUser.Username, FallbackValue='не выбран'}" 
                                   VerticalAlignment="Center"
                                   FontWeight="Bold"
                                   Margin="0,0,20,0"/>

                        <Button Content="🔄 Изменить статус" 
                                Command="{Binding ToggleUserStatusCommand}"
                                Padding="10,5"
                                Background="#FF9800"
                                Foreground="White"
                                MinWidth="120"
                                Margin="0,0,10,0"/>

                        <Button Content="👑 Изменить роль" 
                                Command="{Binding ChangeUserRoleCommand}"
                                Padding="10,5"
                                Background="#2196F3"
                                Foreground="White"
                                MinWidth="120"/>
                    </StackPanel>
                </Border>
            </Grid>
        </GroupBox>
    </Grid>
</UserControl>